import os
submit_job = config["submit_job"]
outdir_abspath = os.path.abspath(config["outdir"])

param_test_email = ""
if "test_email" in config:
    test_email = config["test_email"]
    param_test_email = f"--test-email {test_email} -y 100"


## multi 
run_info4multi = config["multi"]["archive_run"]
fastqpath4multi=config["multi"]["fastqpath"]
projectname4multi = config["multi"]["projectname"]
ref4multi = config["multi"]["ref"]

## multiome
run_info4multiome = config["multiome"]["archive_run"]
fastqpath4multiome=config["multiome"]["fastqpath"]
projectname4multiome = config["multiome"]["projectname"]
ref4multiome = config["multiome"]["ref"]

rule test_sc_rna_exclude_introns:
    input:
        run_snakemake4sc = config["path2run_snakemake_sc"]
    params:
        dir4test = os.path.join(outdir_abspath, config["rna"]["projectname"] + "_rna_exclude_introns/Analysis/")
    output:
        log = os.path.join(outdir_abspath, "test_scRNA_exclude_introns.log")
    shell:
        """
mkdir -p {params.dir4test}
cd {params.dir4test} && echo "{submit_job}" | {input.run_snakemake4sc} {fastqpath4rna} rna {ref} --exclude-introns -p {projectname4rna} -a {run_info4rna} {param_test_email} > {output.log} 2>&1 
"""

rule test_sc_rna_force_cell:
    input:
        run_snakemake4sc = config["path2run_snakemake_sc"]
    params:
        dir4test = os.path.join(outdir_abspath, config["rna"]["projectname"] + "_rna_forcecell/Analysis/"),
        cell_number = config["rna"]["cell_number"]
    output:
        log = os.path.join(outdir_abspath, "test_scRNA_force_cell.log")
    shell:
        """
mkdir -p {params.dir4test}
cd {params.dir4test} && echo "{submit_job}" | {input.run_snakemake4sc} {fastqpath4rna} rna {ref} --force {params.cell_number} -p {projectname4rna} -a {run_info4rna}  {param_test_email} > {output.log} 2>&1
"""

rule test_sc_rna_expect_cell:
    input:
        run_snakemake4sc = config["path2run_snakemake_sc"]
    params:
        dir4test = os.path.join(outdir_abspath, config["rna"]["projectname"] + "_rna_expectcell/Analysis/"),
        cell_number = config["rna"]["cell_number"]
    output:
        log = os.path.join(outdir_abspath, "test_scRNA_expect_cell.log")
    shell:
        """
mkdir -p {params.dir4test}
cd {params.dir4test} && echo "{submit_job}" | {input.run_snakemake4sc} {fastqpath4rna} rna {ref} --expect {params.cell_number} -p {projectname4rna} -a {run_info4rna}  {param_test_email} > {output.log} 2>&1
"""

rule test_sc_multi_default:
    input:
        run_snakemake4sc = config["path2run_snakemake_sc"],
        lib_csv = os.path.abspath(config["multi"]["lib_csv"]),
        metadata = os.path.abspath(config["multi"]["metadata"])
    params:
        dir4test = os.path.join(outdir_abspath, config["multi"]["projectname"] + "_multi_default/Analysis/"),
    output:
        log = os.path.join(outdir_abspath, "test_sc_multi_default.log")
    shell:
        """
mkdir -p {params.dir4test}
cd {params.dir4test} && echo "n" | {input.run_snakemake4sc} {fastqpath4multi} multi {ref4multi}  -p {projectname4multi} -a {run_info4multi} {param_test_email} > {output.log} 2>&1
sed -i 's/""/"libraries.csv"/g' {params.dir4test}/config.py
cp {input.lib_csv} {params.dir4test}/libraries.csv
cp {input.metadata} {params.dir4test}/../
touch archive_setup.complete
cd {params.dir4test} && echo "{submit_job}" | {input.run_snakemake4sc} --rerun 
"""

rule test_sc_multi_exclude_introns:
    input:
        run_snakemake4sc = config["path2run_snakemake_sc"],
        lib_csv = os.path.abspath(config["multi"]["lib_csv"])
    params:
        dir4test = os.path.join(outdir_abspath, config["multi"]["projectname"] + "_multi_exclude_introns/Analysis/"),
    output:
        log = os.path.join(outdir_abspath, "test_sc_multi_exclude_introns.log")
    shell:
        """
mkdir -p {params.dir4test}
cd {params.dir4test} && echo "n" | {input.run_snakemake4sc} {fastqpath4multi} multi {ref4multi} --exclude-introns -p {projectname4multi} -a {run_info4multi} {param_test_email} > {output.log} 2>&1
sed -i 's/""/"libraries.csv"/g' {params.dir4test}/config.py
cp {input.lib_csv} {params.dir4test}/libraries.csv
cd {params.dir4test} && echo "{submit_job}" | {input.run_snakemake4sc} --rerun 
"""

rule test_sc_multi_force_cell:
    input:
        run_snakemake4sc = config["path2run_snakemake_sc"],
        lib_csv = os.path.abspath(config["multi"]["lib_csv"])
    params:
        dir4test = os.path.join(outdir_abspath, config["multi"]["projectname"] + "_multi_forcecell/Analysis/"),
        cell_number = config["multi"]["cell_number"]
    output:
        log = os.path.join(outdir_abspath, "test_sc_multi_forcecell.log")
    shell:
        """
mkdir -p {params.dir4test}
cd {params.dir4test} && echo "n" | {input.run_snakemake4sc} {fastqpath4multi} multi {ref4multi} --force {params.cell_number} -p {projectname4multi} -a {run_info4multi} {param_test_email} > {output.log} 2>&1
sed -i 's/""/"libraries.csv"/g' {params.dir4test}/config.py
cp {input.lib_csv} {params.dir4test}/libraries.csv
cd {params.dir4test} && echo "{submit_job}" | {input.run_snakemake4sc} --rerun 
"""

rule test_sc_multi_expect_cell:
    input:
        run_snakemake4sc = config["path2run_snakemake_sc"],
        lib_csv = os.path.abspath(config["multi"]["lib_csv"])
    params:
        dir4test = os.path.join(outdir_abspath, config["multi"]["projectname"] + "_multi_expectcell/Analysis/"),
        cell_number = config["multi"]["cell_number"]
    output:
        log = os.path.join(outdir_abspath, "test_sc_multi_expectcell.log")
    shell:
        """
mkdir -p {params.dir4test}
cd {params.dir4test} && echo "n" | {input.run_snakemake4sc} {fastqpath4multi} multi {ref4multi} --expect {params.cell_number} -p {projectname4multi} -a {run_info4multi} {param_test_email} > {output.log} 2>&1
sed -i 's/""/"libraries.csv"/g' {params.dir4test}/config.py
cp {input.lib_csv} {params.dir4test}/libraries.csv
cd {params.dir4test} && echo "{submit_job}" | {input.run_snakemake4sc} --rerun 
"""

if "crispr" in config: 
    ## crispr
    run_info4crispr   = config["crispr"]["archive_run"]
    fastqpath4crispr  = config["crispr"]["fastqpath"]
    projectname4crispr = config["crispr"]["projectname"]
    ref4crispr = config["crispr"]["ref"]
    rule test_sc_crispr_default:
        input:
            run_snakemake4sc = config["path2run_snakemake_sc"],
            lib_csv = config["crispr"]["lib_csv"]
        params:
            dir4test = os.path.join(outdir_abspath, config["crispr"]["projectname"] + "_crispr_default/Analysis/"),
        output:
            log = os.path.join(outdir_abspath, "test_sc_crispr_default.log")
        shell:
            """
mkdir -p {params.dir4test}
cd {params.dir4test} && echo "n" | {input.run_snakemake4sc} {fastqpath4crispr} multi {ref4crispr}  -p {projectname4crispr} -a {run_info4crispr} {param_test_email} > {output.log} 2>&1
sed -i 's/""/"libraries.csv"/g' {params.dir4test}/config.py
cp {input.lib_csv} {params.dir4test}/libraries.csv
cd {params.dir4test} && echo "{submit_job}" | {input.run_snakemake4sc} --rerun
"""


rule test_sc_multiome_default:
    input:
        run_snakemake4sc = config["path2run_snakemake_sc"],
        lib_csv = config["multiome"]["lib_csv"]
    params:
        dir4test = os.path.join(outdir_abspath, config["multiome"]["projectname"] + "_multiome_default/Analysis/"),
    output:
        log = os.path.join(outdir_abspath, "test_sc_multiome_default.log")
    shell:
        """
mkdir -p {params.dir4test}
cd {params.dir4test} && echo "n" | {input.run_snakemake4sc} {fastqpath4multiome} multiome {ref4multiome}  -p {projectname4multiome} -a {run_info4multiome} {param_test_email} > {output.log} 2>&1
sed -i 's/""/"libraries.csv"/g' {params.dir4test}/config.py
cp {input.lib_csv} {params.dir4test}/libraries.csv
cd {params.dir4test} && echo "{submit_job}" | {input.run_snakemake4sc} --rerun 
"""

rule test_sc_multiome_exclude_exons:
    input:
        run_snakemake4sc = config["path2run_snakemake_sc"],
        lib_csv = config["multiome"]["lib_csv"]
    params:
        dir4test = os.path.join(outdir_abspath, config["multiome"]["projectname"] + "_multiome_exclude_exons/Analysis/"),
    output:
        log = os.path.join(outdir_abspath, "test_sc_multiome_exclude_exons.log")
    shell:
        """
mkdir -p {params.dir4test}
cd {params.dir4test} && echo "n" | {input.run_snakemake4sc} {fastqpath4multiome} multiome {ref4multiome} --exclude-introns  -p {projectname4multiome} -a {run_info4multiome} {param_test_email} > {output.log} 2>&1
sed -i 's/""/"libraries.csv"/g' {params.dir4test}/config.py
cp {input.lib_csv} {params.dir4test}/libraries.csv
cd {params.dir4test} && echo "{submit_job}" | {input.run_snakemake4sc} --rerun 
"""

include: "rules/test_rna.smk"
include: "rules/test_spatia.smk"
include: "rules/test_rna_full.smk"
include: "rules/test_vdj.smk"

rule all:
    input:
        rules.test_sc_rna_full_default.output.log,
        rules.test_sc_spatial_default.output.log,
        rules.test_sc_rna_expect_cell.output.log,
        rules.test_sc_rna_force_cell.output.log,
        rules.test_sc_rna_exclude_introns.output.log,
        rules.test_sc_rna_default.output.log,
        rules.test_sc_multi_default.output.log,
        rules.test_sc_multi_force_cell.output.log,
        rules.test_sc_multi_expect_cell.output.log,
        rules.test_sc_vdj_default.output.log,
        rules.test_sc_vdj_chain.output.log,
        rules.test_sc_multiome_default.output.log,
        rules.test_sc_multiome_exclude_exons.output.log
